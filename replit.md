# Overview

VioConcierge is an intelligent, multi-tenant SaaS platform designed to automate outbound calling for appointment reminders across various business sectors. Its primary goal is to reduce appointment no-shows through AI-powered voice calls, comprehensive contact management, and robust analytics. The platform supports multiple user roles, ensures strong tenant isolation, and integrates with external calendar systems. It aims to optimize appointment management and client engagement for businesses.

# User Preferences

Preferred communication style: Simple, everyday language.

# System Architecture

## UI/UX Decisions
The frontend is a React SPA using TypeScript and Vite, styled with Radix UI, shadcn/ui, and Tailwind CSS. It uses Wouter for routing and React Hook Form with Zod for form management.

## Technical Implementations
The backend is an Express.js application with Node.js and TypeScript, following a RESTful API design. Drizzle ORM is used for database interactions. Authentication is JWT-based with role-based access control. The system features multi-tenancy enforced at both database and API levels, with dynamic API calls and enhanced cache management for strict tenant data isolation.

**Redis & Scaling Strategy (Oct 2025)**: Rate limiting uses local Redis with automatic fallback, supporting 20-30 concurrent clients on a single Replit instance. For scaling beyond 50+ clients, implement distributed Redis (Upstash with `rediss://` TLS URL or REST API) by adding `REDIS_URL` environment variable. Current setup provides production-ready rate limiting for initial deployment without external dependencies.

## Feature Specifications
- **Multi-tenancy**: Strict isolation with super admin, client admin, and client user roles.
- **Contact Management**: CSV import/export, deduplication, and E.164 phone normalization.
- **Appointment Management**: "Call Now" and "Cancel Call" features, robust error handling, and automated cleanup.
- **Call Status Display**: Intelligent, outcome-based status labeling (e.g., "No Answer", "Voicemail", "Confirmed").
- **AI Voice Agent**: Uses a unified prompt for professional outbound and enthusiastic inbound calls, with configurable travel/parking directions and dynamic company name resolution. **PERSONALIZATION FIX (Oct 2025)**: Fixed critical variable mapping issues - Clara now properly uses contact first names (`{{name}}` variable) for personalized, friendly greetings ("Hi Vienna" instead of "Hi Vienna Barnes") and correctly accesses tenant-configured travel directions (`publicTransportInstructions`, `parkingInstructions`, `arrivalNotes`) for location guidance. **HYBRID WEBHOOK + POLLING SYSTEM (Oct 2025)**: Implemented production-ready dual-track call outcome tracking with guaranteed reliability: (1) **Webhook Primary Path** - Raw request body capture via `express.raw()` middleware enables HMAC-SHA256 signature verification using `retellApiKey` per Retell AI official docs (signature = HMAC-SHA256(request_body, api_key)), fixing critical signature failures. Idempotent event storage via `retell_events` table with UNIQUE constraint on (call_id, event_type, digest) prevents duplicate processing. Outcome precedence hierarchy (rescheduled > cancelled > confirmed > voicemail > no_answer > busy > answered > failed > unknown) prevents weak signals from overwriting strong confirmations; (2) **Polling Fallback Path** - Background worker with exponential backoff (15s → 30s → 60s → 120s → 600s cap) guarantees outcome delivery even if webhooks fail. Each call session tracks `poll_attempts`, `next_poll_at`, `webhook_verified`, `source_of_truth`, and separate payloads (`payload_webhook_last`, `payload_poll_last`) for audit trail. Polling auto-stops when webhook delivers outcome or terminal state reached. Dead-letter queue detects calls stuck >30min without outcome. **CRITICAL API FIELD MAPPING FIX (Oct 2025)**: Fixed polling service bug where Retell's `getCall()` API returns `call_status` field but code was checking non-existent `status` field, causing all polled calls to be marked as "failed/unknown". Polling service now correctly extracts `call_status` from API responses, properly detects terminal states ("ended", "completed"), and updates appointment statuses. **CRITICAL POLLING TIMING FIX (Oct 2025)**: Fixed premature polling issue where system was checking call status after only 15 seconds, when most calls are still in progress ("ongoing" status with no analysis data). Changed initial poll delay from 15s to 90s across all call types (scheduled calls, manual "Call Now"), allowing calls to complete naturally (most finish within 60-90 seconds) before outcome verification. Prevents false "failed" notifications for successful calls; (3) **State Consistency** - Precedence logic enforced in both paths via `mergeCallSessionState()` prevents outcome downgrades. Order-independent processing with SHA256 digest-based deduplication ensures webhooks arriving out-of-order don't corrupt state. Transition guards prevent duplicate confirmations. System scales to 2-10 concurrent clients with guaranteed idempotency and reliability.
- **Travel & Parking Directions**: Client admins configure arrival instructions for the AI voice agent, with character limits and validation.
- **Tenant Configuration**: Super admins use a 7-step wizard for tenant creation with template-driven setup. Hybrid business hours system (super admin defaults, client admin customization) with `BusinessHoursEvaluator` for call validation. **Tenant Settings Editor (Oct 2025)**: Super admins can edit existing tenant configurations post-creation via settings editor modal with tabs for Retell AI, Calendar Integration (Cal.com/Calendly), Business Settings, and Features. The Business Settings tab now includes a Business Template selector (Medical, Salon, Restaurant, Professional, General, Custom) allowing super admins to change the template after creation - changes update both tenant.businessTemplate and tenantConfig.businessType for consistency. The Features tab allows toggling core premium features (Premium Access, HIPAA Compliance, Custom Branding, API Access) and additional features (Advanced Analytics, Bulk Operations, Multi-Location Support, Custom Fields, Advanced Scheduling, Priority Support). **Tenant Impersonation (Oct 2025)**: Super admins can visit tenant accounts via impersonation flow - banner displays in header across all routes when impersonating, with "Exit Tenant View" button to return to super admin dashboard.
- **Calendar Integration**: Supports Cal.com and Calendly for appointment reschedule detection.
- **Analytics**: Dashboard for Call Success Rate, Appointment Confirmation, No-Show Reduction, and Daily Call Volume.
- **Data Export & Compliance**: CSV export for contacts, appointments, and call logs; GDPR Article 20 compliant JSON export.
- **Daily Email Summaries**: **Tenant-level configuration** (Oct 2025): Client admins configure a single recipient (name and email address) to receive daily summaries on behalf of their organization. Summaries include detailed contact information (names, appointment times, outcomes) with actionable breakdowns: Recently Confirmed, Rescheduled, Cancelled, No Answer (needs follow-up), Voicemail Left, and Failed Calls. Client admins set delivery time (HH:MM), delivery days (weekdays/weekends), and timezone via Profile Settings. System sends ONE email per tenant per day to the configured recipient address, with duplicate prevention via `lastDailySummarySentAt` timestamp tracking. Delivered timezone-aware with up to 10 contacts per section. **Migration Note**: Replaced user-level preferences with tenant-level configuration for simplified management and clearer ownership.
- **User Account Settings**: Users can update personal information (full name, email) with email uniqueness enforced within tenant boundaries.
- **Call Settings & Preferences**: Client admins configure initial appointment reminder times (default: 24h before appointment). System allows up to **3 calls per day per contact**: (1) ONE initial reminder call automatically scheduled, (2) ONE follow-up call automatically scheduled if initial call is missed/not answered (default: 90 minutes after missed call), and (3) ONE manual call if needed via "Call Now" button for urgent situations. If appointment is confirmed, NO additional calls are made. This prevents duplicate calls to customers who have already confirmed their appointments. The 3-call limit provides flexibility while preventing harassment. **BUG FIX (Oct 2025)**: Fixed critical issue where follow-up calls were not being scheduled when initial calls failed. Webhook handlers now automatically create follow-up tasks when call outcomes are no_answer/voicemail/busy/failed, with duplicate prevention via pending task checks.
- **Team Management**: Client admins can invite team members (client_admin or client_user), manage roles, and activate/deactivate users via a secure, token-based invitation system.
- **Audit Trail**: Comprehensive, tamper-proof audit logs with hash-chained integrity verification, advanced filtering, and CSV export. Includes all login attempts, user activity, data exports, and system actions, with a 7-year retention policy.
- **Privacy Policy**: Comprehensive, publicly accessible privacy policy page (UK GDPR compliant) detailing data collection, processing, retention, and user rights. Accessible from login page without authentication.
- **Dark Mode**: Full dark mode support with Tailwind class-based theming. Theme toggle available on login page (unauthenticated users) and in header (authenticated users). Theme preference persists via localStorage across sessions.
- **In-App Notifications**: Real-time notification system with bell icon in header displaying unread count badge. Notifications are created automatically for key events (login, tenant creation, call outcomes). Users can mark individual notifications as read or mark all as read. Categories include: security_event, tenant_update, call_status, appointment, user_action. Notifications refresh every 30 seconds and support filtering by type, priority (low/normal/high/urgent), and read status. Multi-user broadcast uses Promise.allSettled for reliable delivery.
- **Comprehensive User Guides**: Client Admin and Super Admin guides provide practical, step-by-step instructions for platform success. Guides include: 30-day onboarding roadmap, industry-specific optimization strategies (Healthcare, Beauty/Wellness, Professional Services), voice AI configuration best practices, no-show reduction strategies targeting 40-60% improvement, ROI calculation examples with clear assumptions, calendar integration setup, team management workflows, troubleshooting guidance, and advanced feature utilization. All content uses aspirational language with realistic, achievable metrics and properly qualified performance claims.
- **Client Onboarding Checklist**: Comprehensive, printable checklist for super admins covering all aspects of client onboarding. Includes: Platform API keys & services (required/optional), client information gathering (business details, contact data, branding), system configuration (tenant creation, voice AI setup, call settings, email notifications), data setup (contact import, appointment sync), user access setup (admin accounts, team invitations), testing & validation (test workflows, feature verification), training & handoff (documentation, support), post-launch monitoring (30-day monitoring plan), and quick reference for environment variables. Accessible via sidebar navigation with print functionality for offline use.
- **Configurable Abuse Protection**: Super admins can adjust rate limiting and protection thresholds via Settings dialog on Abuse Protection page. Configurable parameters: max login attempts per email (1-20, default: 5), max attempts per IP (1-50, default: 10), time window in minutes (5-60, default: 15), and lockout duration in minutes (5-1440, default: 30). Settings stored in database with 1-minute in-memory cache for performance. System uses last-known-good configuration as fallback when database unavailable. Changes apply immediately to all login attempts and rate limiting.

# External Dependencies

- **Database**: PostgreSQL (via Neon serverless connection)
- **Voice AI**: Retell AI
- **Calendar Integration**: Cal.com and Calendly APIs
- **Email Service**: Resend API